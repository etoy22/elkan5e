{
	"name": "Suffocation",
	"type": "script",
	"_id": "H5g2Kf9b8VqL4tYc",
	"author": "71r7qVMKZkbQ86li",
	"img": "modules/elkan5e/icons/hazards/suffocation.svg",
	"scope": "global",
	"command": "(async () => {\n  const _args = globalThis.args ?? [];\n  const lastArg = _args.at(-1) ?? {};\n\n  const resolveToken = async () => {\n    const id = lastArg.tokenId ?? lastArg.token?.id;\n    if (id) {\n      const t = canvas?.tokens?.get(id);\n      if (t) return t;\n    }\n\n    if (lastArg.tokenUuid) {\n      try {\n        const doc = await fromUuid(lastArg.tokenUuid || \"\");\n        if (doc?.object) return doc.object;\n      } catch (error) {\n        console.warn(\"Elkan 5e | Failed to resolve suffocation token\", error);\n      }\n    }\n\n    if (lastArg.token) return lastArg.token.object ?? lastArg.token;\n\n    const controlled = canvas?.tokens?.controlled?.[0];\n    if (controlled) return controlled;\n\n    const speaker = ChatMessage.getSpeaker();\n    if (speaker?.token) {\n      const t = canvas?.tokens?.get(speaker.token);\n      if (t) return t;\n    }\n\n    const char = game.user?.character;\n    if (char) {\n      const owned = canvas?.tokens?.placeables?.find((pt) => pt?.actor?.id === char.id);\n      if (owned) return owned;\n    }\n\n    const firstOwned = canvas?.tokens?.placeables?.find((pt) => pt.document?.isOwner);\n    if (firstOwned) return firstOwned;\n\n    return null;\n  };\n\n  const token = await resolveToken();\n  if (!token) {\n    ui.notifications.error(\"Elkan 5e | No token context for suffocation exhaustion\");\n    return {};\n  }\n\n  let actor = token.actor ?? null;\n  if (!actor && lastArg.actorUuid) {\n    const doc = await fromUuid(lastArg.actorUuid);\n    actor = doc?.actor ?? doc ?? null;\n  }\n  if (!actor) return {};\n\n  const current = Number(actor.system?.attributes?.exhaustion ?? 0);\n  if (current >= 6) return {};\n\n  const target = Math.min(6, current + 1);\n  const delta = target - current;\n  if (!delta) return {};\n\n  await actor.update({ \"system.attributes.exhaustion\": target });\n\n  const stored = await actor.getFlag(\"elkan5e\", \"suffocationStates\");\n  const states = foundry.utils.duplicate(stored ?? {});\n  states.effects ??= {};\n  states.exhaustion = Math.max(0, Number(states.exhaustion ?? 0)) + delta;\n  await actor.setFlag(\"elkan5e\", \"suffocationStates\", states);\n  return {};\n})();",
	"folder": "Z0WbSeZ2agJTALHX",
	"_key": "!macros!H5g2Kf9b8VqL4tYc"
}